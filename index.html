<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Mode Secure P2P</title>
    
    <!-- CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --accent: #0984e3;
            --border-radius: 12px;
            --font-stack: 'Segoe UI', system-ui, sans-serif;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        /* --- THEME MODES --- */
        body.mode-teacher { --bg-color: #e3f2fd; --accent: #1976d2; --font-stack: 'Verdana', sans-serif; }
        body.mode-student { --bg-color: #f1f8e9; --accent: #7cb342; --font-stack: 'Verdana', sans-serif; }
        body.mode-company { --bg-color: #2c3e50; --card-bg: #34495e; --text-main: #ecf0f1; --accent: #e67e22; --border-radius: 4px; }
        body.mode-anime { --bg-color: #240046; --card-bg: rgba(60, 9, 108, 0.9); --text-main: #e0aaff; --accent: #ff006e; --border-radius: 25px; }
        body.mode-hacker { --bg-color: #000; --card-bg: #001100; --text-main: #0f0; --accent: #0f0; --font-stack: 'Courier New', monospace; --border-radius: 0; }
        body.mode-developer { --bg-color: #1e1e1e; --card-bg: #2d2d2d; --text-main: #d4d4d4; --accent: #007acc; --font-stack: 'Consolas', monospace; }

        /* --- LAYOUT --- */
        body { margin: 0; padding: 20px; font-family: var(--font-stack); background: var(--bg-color); color: var(--text-main); transition: 0.3s; }
        .container { max-width: 850px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-select-wrapper { background: var(--card-bg); padding: 10px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-family: inherit; }

        .main-card { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); position: relative; overflow: hidden; }

        /* --- DYNAMIC FEATURE TOOLBARS --- */
        .feature-bar { 
            display: none; /* Hidden by default */
            background: rgba(0,0,0,0.05); 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: var(--border-radius); 
            border-left: 5px solid var(--accent);
        }

        /* --- UPLOADER --- */
        #drop-zone { border: 3px dashed rgba(0,0,0,0.2); border-radius: var(--border-radius); padding: 40px; text-align: center; cursor: pointer; transition: 0.2s; }
        #drop-zone:hover, #drop-zone.dragover { border-color: var(--accent); background: rgba(0,0,0,0.05); }
        
        .file-info { margin-top: 15px; font-weight: bold; }
        .rename-preview { font-size: 0.9em; color: var(--accent); margin-top: 5px; font-style: italic; }

        /* --- BUTTONS --- */
        .btn-primary { 
            background: var(--accent); color: white; border: none; padding: 12px 30px; 
            border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; 
            margin-top: 20px; font-family: inherit; font-weight: bold; width: 100%;
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- DEVELOPER CONSOLE --- */
        #dev-console { background: #111; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 20px; display: none; }

        /* --- RESULTS --- */
        #result-area { display: none; text-align: center; margin-top: 30px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; }
        
        /* --- UTILS --- */
        .badge { background: var(--accent); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; text-transform: uppercase; }
        .error-msg { color: #e74c3c; font-weight: bold; display: none; margin-top: 10px; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; display: none; pointer-events: none; }

    </style>
</head>
<body>

    <canvas id="matrix-canvas"></canvas>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-network-wired"></i> <span id="app-title">SecureShare</span></h1>
            <div class="mode-select-wrapper">
                <label><strong>Current Mode:</strong></label>
                <select id="mode-selector">
                    <option value="default">Default</option>
                    <optgroup label="Education">
                        <option value="teacher">Teacher Mode (Strict)</option>
                        <option value="student">Student Mode (Submit)</option>
                    </optgroup>
                    <optgroup label="Enterprise">
                        <option value="company">Company Mode (Secure)</option>
                        <option value="hacker">Hacker Mode (Terminal)</option>
                    </optgroup>
                    <optgroup label="Media">
                        <option value="anime">Anime Mode (Batch)</option>
                    </optgroup>
                    <optgroup label="Dev">
                        <option value="developer">Developer Mode (Debug)</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="main-card">
            
            <!-- FEATURE: TEACHER TOOLBAR -->
            <div id="ui-teacher" class="feature-bar">
                <h3><i class="fas fa-chalkboard-teacher"></i> Classroom Controls</h3>
                <p>Security Level: <strong>High</strong>. Executable files (.exe, .bat) are <strong>BLOCKED</strong>.</p>
                <p>Max File Size: <strong>100MB</strong></p>
                <div style="display:flex; gap: 5px; flex-wrap:wrap;" id="roster-visual"></div>
            </div>

            <!-- FEATURE: COMPANY TOOLBAR -->
            <div id="ui-company" class="feature-bar">
                <div class="badge">CONFIDENTIAL</div>
                <h3><i class="fas fa-lock"></i> Corporate Security</h3>
                <p>File will be renamed with <code>[CONFIDENTIAL]</code> prefix.</p>
                <label>Set Access Password (Optional):</label>
                <input type="password" id="company-password" placeholder="Enter password to lock link...">
            </div>

            <!-- FEATURE: ANIME TOOLBAR -->
            <div id="ui-anime" class="feature-bar">
                <h3><i class="fas fa-tv"></i> Episode Renamer</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="season-num" placeholder="Season" value="1" style="width: 60px;">
                    <input type="number" id="ep-num" placeholder="Episode" value="1" style="width: 60px;">
                </div>
                <small>File will auto-rename to <code>S01E01 - [Filename]</code></small>
            </div>

            <!-- DROP ZONE -->
            <div id="drop-zone">
                <i class="fas fa-cloud-upload-alt" style="font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
                <p id="drop-text">Drag & Drop file here</p>
                <input type="file" id="file-input" style="display:none;">
            </div>

            <div class="file-info" id="file-info"></div>
            <div class="rename-preview" id="rename-preview"></div>
            <div class="error-msg" id="error-msg"></div>

            <button id="action-btn" class="btn-primary" disabled>Start Upload</button>

            <!-- DEV CONSOLE -->
            <div id="dev-console">
                <div>> System Ready.</div>
            </div>

            <!-- RESULT AREA -->
            <div id="result-area">
                <h3><i class="fas fa-check-circle"></i> Seeding Active</h3>
                <div id="link-container">
                    <label>Secure Link:</label>
                    <input type="text" id="share-link" readonly>
                    <button onclick="copyLink()" style="margin-top: 10px; padding: 5px 10px; cursor: pointer;">Copy</button>
                </div>
                <div id="qrcode" style="margin-top: 20px; display: flex; justify-content: center;"></div>
                
                <!-- Dev Stats -->
                <div id="webrtc-stats" style="margin-top: 15px; font-size: 0.8em; color: #888; display:none;">
                    Speed: <span id="speed-stat">0</span> | Peers: <span id="peer-stat">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- AUDIO FOR HACKER MODE -->
    <audio id="sfx-key" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_ff15c0e181.mp3"></audio>

    <!-- WORKER -->
    <script id="worker-code" type="javascript/worker">
        self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js');
        self.onmessage = function(e) {
            if(e.data.action === 'encrypt') {
                const key = CryptoJS.lib.WordArray.random(32);
                const iv = CryptoJS.lib.WordArray.random(16);
                const wordArray = CryptoJS.lib.WordArray.create(e.data.fileData);
                const encrypted = CryptoJS.AES.encrypt(wordArray, key, { iv: iv });
                self.postMessage({ status: 'done', key: key.toString(), encrypted: encrypted.toString() });
            }
        }
    </script>

    <script>
        // --- 1. SYSTEM CONFIGURATION ---
        const client = new WebTorrent();
        let currentMode = 'default';
        let originalFile = null;
        let finalFileToSeed = null; // This holds the renamed/modified file

        const DOM = {
            body: document.body,
            selector: document.getElementById('mode-selector'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            fileInfo: document.getElementById('file-info'),
            renamePreview: document.getElementById('rename-preview'),
            errorMsg: document.getElementById('error-msg'),
            actionBtn: document.getElementById('action-btn'),
            resultArea: document.getElementById('result-area'),
            shareLink: document.getElementById('share-link'),
            qr: document.getElementById('qrcode'),
            console: document.getElementById('dev-console'),
            passwordInput: document.getElementById('company-password')
        };

        // --- 2. LOGIC HANDLERS ---
        DOM.selector.addEventListener('change', (e) => setMode(e.target.value));
        DOM.dropZone.addEventListener('click', () => DOM.fileInput.click());
        DOM.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); DOM.dropZone.classList.add('dragover'); });
        DOM.dropZone.addEventListener('dragleave', () => DOM.dropZone.classList.remove('dragover'));
        DOM.dropZone.addEventListener('drop', handleDrop);
        DOM.fileInput.addEventListener('change', (e) => processFile(e.target.files[0]));
        DOM.actionBtn.addEventListener('click', startProcess);

        // --- 3. MODE SWITCHING LOGIC ---
        function setMode(mode) {
            currentMode = mode;
            DOM.body.className = `mode-${mode}`; // Apply Theme
            
            // Hide all toolbars
            document.querySelectorAll('.feature-bar').forEach(el => el.style.display = 'none');
            DOM.console.style.display = 'none';
            DOM.errorMsg.style.display = 'none';
            document.getElementById('matrix-canvas').style.display = 'none';

            // Show specific toolbars & Apply specific logic
            if(mode === 'teacher') {
                document.getElementById('ui-teacher').style.display = 'block';
                renderTeacherRoster();
            }
            else if(mode === 'company') {
                document.getElementById('ui-company').style.display = 'block';
            }
            else if(mode === 'anime') {
                document.getElementById('ui-anime').style.display = 'block';
            }
            else if(mode === 'developer') {
                DOM.console.style.display = 'block';
            }
            else if(mode === 'hacker') {
                document.getElementById('matrix-canvas').style.display = 'block';
                startMatrix();
            }

            // Re-process file if one is selected (to apply new renaming logic)
            if(originalFile) processFile(originalFile);
            
            log(`System switched to: ${mode.toUpperCase()} Mode`);
        }

        // --- 4. FILE PROCESSING PIPELINE ---
        function handleDrop(e) {
            e.preventDefault();
            DOM.dropZone.classList.remove('dragover');
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        }

        function processFile(file) {
            originalFile = file;
            DOM.errorMsg.style.display = 'none';
            DOM.actionBtn.disabled = true;
            DOM.renamePreview.innerText = '';
            
            // --- VALIDATOR LOGIC (Feature: Teacher Mode Blocking) ---
            if(currentMode === 'teacher') {
                const ext = file.name.split('.').pop().toLowerCase();
                if(['exe', 'bat', 'msi', 'sh', 'bin'].includes(ext)) {
                    showError("SECURITY ALERT: Executable files are blocked in Teacher Mode.");
                    return;
                }
                if(file.size > 100 * 1024 * 1024) {
                    showError("LIMIT ALERT: Files > 100MB are blocked in Teacher Mode.");
                    return;
                }
            }

            // --- TRANSFORMER LOGIC (Feature: Renaming) ---
            let newName = file.name;

            if(currentMode === 'student') {
                // FEATURE: Auto-rename with Student ID
                const studentId = Math.floor(Math.random() * 90000) + 10000;
                newName = `ID${studentId}_${new Date().toISOString().split('T')[0]}_${file.name}`;
            }
            else if(currentMode === 'company') {
                // FEATURE: Confidential Prefix
                newName = `[CONFIDENTIAL]_${file.name}`;
            }
            else if(currentMode === 'anime') {
                // FEATURE: S01E01 Format
                const s = document.getElementById('season-num').value.padStart(2,'0');
                const e = document.getElementById('ep-num').value.padStart(2,'0');
                newName = `S${s}E${e} - ${file.name}`;
            }

            // Create new File object with modified name
            finalFileToSeed = new File([file.slice(0, file.size, file.type)], newName, {type: file.type});

            // UI Update
            DOM.fileInfo.innerText = `${file.name} (${formatBytes(file.size)})`;
            if(newName !== file.name) {
                DOM.renamePreview.innerText = `Renaming to: ${newName}`;
            }
            DOM.actionBtn.disabled = false;
            DOM.actionBtn.innerText = currentMode === 'student' ? 'Submit Assignment' : 'Start Upload';
            
            if(currentMode === 'hacker') playSound();
        }

        // --- 5. ENCRYPTION & SEEDING ---
        function startProcess() {
            DOM.actionBtn.disabled = true;
            DOM.actionBtn.innerText = "Encrypting...";
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Encryption Worker (Standard for all modes)
                const blob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
                const worker = new Worker(URL.createObjectURL(blob));
                
                worker.postMessage({ action: 'encrypt', fileData: e.target.result });
                worker.onmessage = function(ev) {
                    log("Encryption Complete. Hashing...");
                    seedFile(finalFileToSeed, ev.data.key); // Seed the RENAMED file
                    worker.terminate();
                };
            };
            reader.readAsArrayBuffer(finalFileToSeed);
        }

        function seedFile(file, key) {
            DOM.actionBtn.innerText = "Seeding...";
            
            client.seed(file, (torrent) => {
                log(`Torrent created. InfoHash: ${torrent.infoHash}`);
                
                // --- LINK GENERATION LOGIC ---
                let url = `${window.location.origin}${window.location.pathname}?magnet=${encodeURIComponent(torrent.magnetURI)}&key=${key}`;
                
                // FEATURE: Company Password
                if(currentMode === 'company') {
                    const pass = DOM.passwordInput.value;
                    if(pass) {
                        // In a real app, hash this. Here we simulate passing params.
                        url += `&protected=true&hint=${btoa(pass.substring(0,2))}`; 
                    }
                }

                showResult(url, torrent);
            });
        }

        function showResult(url, torrent) {
            DOM.resultArea.style.display = 'block';
            DOM.shareLink.value = url;
            DOM.actionBtn.innerText = "Done";
            
            DOM.qr.innerHTML = "";
            new QRCode(DOM.qr, { text: url, width: 128, height: 128 });

            // FEATURE: Developer Mode Stats
            if(currentMode === 'developer') {
                document.getElementById('webrtc-stats').style.display = 'block';
                setInterval(() => {
                    document.getElementById('speed-stat').innerText = formatBytes(torrent.uploadSpeed) + '/s';
                    document.getElementById('peer-stat').innerText = torrent.numPeers;
                }, 1000);
            }
        }

        // --- UTILS ---
        function showError(msg) {
            DOM.errorMsg.style.display = 'block';
            DOM.errorMsg.innerText = msg;
            DOM.actionBtn.disabled = true;
        }

        function log(msg) {
            console.log(msg);
            const l = document.createElement('div');
            l.innerText = `> ${msg}`;
            DOM.console.appendChild(l);
            DOM.console.scrollTop = DOM.console.scrollHeight;
        }

        function formatBytes(a,b=2){if(!+a)return"0 Bytes";const c=0>b?0:b,d=Math.floor(Math.log(a)/Math.log(1024));return`${parseFloat((a/Math.pow(1024,d)).toFixed(c))} ${["Bytes","KB","MB","GB","TB"][d]}`}
        
        function copyLink() { DOM.shareLink.select(); document.execCommand('copy'); alert('Copied!'); }

        function playSound() { document.getElementById('sfx-key').play().catch(()=>{}); }

        // --- VISUAL EXTRAS ---
        function renderTeacherRoster() {
            const el = document.getElementById('roster-visual');
            el.innerHTML = '';
            for(let i=0; i<15; i++) {
                const d = document.createElement('div');
                d.style.cssText = `width:20px; height:20px; background:${Math.random()>0.5?'#2ecc71':'#ccc'}; border-radius:50%;`;
                el.appendChild(d);
            }
        }

        function startMatrix() {
            const c = document.getElementById('matrix-canvas');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const cols = Math.floor(c.width/20);
            const ypos = Array(cols).fill(0);
            setInterval(() => {
                ctx.fillStyle = '#0001'; ctx.fillRect(0,0,c.width,c.height);
                ctx.fillStyle = '#0f0'; ctx.font = '15pt monospace';
                ypos.forEach((y,i) => {
                    ctx.fillText(String.fromCharCode(Math.random()*128), i*20, y);
                    ypos[i] = y > 100 + Math.random()*10000 ? 0 : y+20;
                });
            }, 50);
        }

    </script>
</body>
</html>
