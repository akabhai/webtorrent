<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Secure Ultimate Sharer</title>
    
    <!-- EXTERNAL LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS SAME AS BEFORE - KEPT COMPACT FOR LOGIC FOCUS */
        :root { --bg: #f4f7f6; --accent: #3498db; --font: 'Segoe UI', sans-serif; }
        body.mode-teacher { --bg: #e3f2fd; --accent: #0288d1; }
        body.mode-company { --bg: #2c3e50; --accent: #f39c12; color: #fff; }
        body.mode-anime { --bg: #120024; --accent: #ff007a; color: #e0aaff; }
        body.mode-hacker { --bg: #000; --accent: #0f0; color: #0f0; font-family: monospace; }
        
        body { background: var(--bg); font-family: var(--font); padding: 20px; transition: 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.9); padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #333; }
        body.mode-hacker .container, body.mode-company .container, body.mode-anime .container { background: rgba(0,0,0,0.6); color: inherit; }
        
        #drop-zone { border: 3px dashed var(--accent); padding: 40px; text-align: center; cursor: pointer; border-radius: 8px; margin-bottom: 20px; }
        button { background: var(--accent); color: #fff; border: none; padding: 12px 20px; width: 100%; font-size: 1em; cursor: pointer; border-radius: 5px; }
        button:disabled { opacity: 0.5; }
        #result-area { display: none; margin-top: 20px; text-align: center; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2>SecureShare</h2>
            <select id="mode-select" onchange="setMode(this.value)">
                <option value="default">Default</option>
                <option value="teacher">Teacher</option>
                <option value="company">Company</option>
                <option value="anime">Anime</option>
                <option value="hacker">Hacker</option>
            </select>
        </div>

        <!-- UPLOADER -->
        <div id="drop-zone" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3em;"></i>
            <h3 id="status-text">Click to Upload</h3>
            <input type="file" id="file-input" style="display: none;" onchange="processFile(this.files[0])">
        </div>

        <button id="btn-encrypt" disabled onclick="startEncryption()">Generate Secure Link</button>

        <!-- RESULT -->
        <div id="result-area">
            <h3>Seeding Active</h3>
            <input type="text" id="share-link" readonly>
            <div id="qrcode" style="margin-top:15px; display:inline-block; background:white; padding:10px;"></div>
        </div>
    </div>

    <!-- WORKER -->
    <script id="worker-script" type="javascript/worker">
        self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js');
        self.onmessage = function(e) {
            const { action, fileData } = e.data;
            if (action === 'encrypt') {
                try {
                    // 1. Generate Key (256-bit) & IV (128-bit)
                    const key = CryptoJS.lib.WordArray.random(32);
                    const iv = CryptoJS.lib.WordArray.random(16);
                    
                    // 2. Encrypt
                    const wordArray = CryptoJS.lib.WordArray.create(fileData);
                    const encrypted = CryptoJS.AES.encrypt(wordArray, key, { iv: iv }).toString();
                    
                    // 3. Pack IV and Ciphertext together (IV:CIPHERTEXT)
                    // This fixes the decryption error!
                    const packet = iv.toString(CryptoJS.enc.Hex) + ':' + encrypted;
                    
                    self.postMessage({ 
                        status: 'success', 
                        key: key.toString(CryptoJS.enc.Hex), 
                        encryptedPacket: packet 
                    });
                } catch(err) {
                    self.postMessage({ status: 'error', msg: err.message });
                }
            }
        }
    </script>

    <script>
        // FIXED TRACKER LIST
        const trackers = [
            'wss://tracker.openwebtorrent.com',
            'wss://tracker.files.fm:7073/announce',
            'wss://tracker.webtorrent.dev'
        ];

        const client = new WebTorrent({ tracker: { announce: trackers } });
        let selectedFile = null;
        let mode = 'default';

        function setMode(m) {
            mode = m;
            document.body.className = `mode-${m}`;
        }

        function processFile(file) {
            if(!file) return;
            selectedFile = file;
            document.getElementById('status-text').innerText = `Selected: ${file.name}`;
            document.getElementById('btn-encrypt').disabled = false;
        }

        function startEncryption() {
            const btn = document.getElementById('btn-encrypt');
            btn.disabled = true;
            btn.innerText = "Encrypting (Please Wait)...";

            const reader = new FileReader();
            reader.onload = function(e) {
                const blob = new Blob([document.getElementById('worker-script').textContent], {type: "text/javascript"});
                const worker = new Worker(URL.createObjectURL(blob));

                // Send ArrayBuffer to Worker
                worker.postMessage({ action: 'encrypt', fileData: e.target.result });
                
                worker.onmessage = function(ev) {
                    if(ev.data.status === 'success') {
                        // Create file from the IV:DATA packet
                        const secureFile = new File([ev.data.encryptedPacket], selectedFile.name, {type: "text/plain"});
                        seedFile(secureFile, ev.data.key);
                        worker.terminate();
                    }
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        }

        function seedFile(file, key) {
            document.getElementById('btn-encrypt').innerText = "Seeding to Network...";
            
            client.seed(file, { announce: trackers }, (torrent) => {
                const path = window.location.pathname.replace(/\/index\.html$/, '').replace(/\/$/, '');
                const url = `${window.location.origin}${path}/stream.html?magnet=${encodeURIComponent(torrent.magnetURI)}&key=${key}`;
                
                document.getElementById('result-area').style.display = 'block';
                document.getElementById('share-link').value = url;
                new QRCode(document.getElementById('qrcode'), { text: url, width: 128, height: 128 });
                
                document.getElementById('btn-encrypt').innerText = "Done";
            });
        }
    </script>
</body>
</html>
