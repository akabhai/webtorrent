<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Downloader</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* MATCHING STYLES */
        :root { --bg: #f4f7f6; --accent: #3498db; --font: 'Segoe UI', sans-serif; }
        body.mode-teacher { --bg: #e3f2fd; --accent: #0288d1; }
        body.mode-company { --bg: #2c3e50; --accent: #f39c12; color: #fff; }
        body.mode-anime { --bg: #120024; --accent: #ff007a; color: #e0aaff; }
        body.mode-hacker { --bg: #000; --accent: #0f0; color: #0f0; font-family: monospace; }
        
        body { background: var(--bg); font-family: var(--font); padding: 20px; transition: 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.9); padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #333; text-align: center; }
        body.mode-hacker .container, body.mode-company .container, body.mode-anime .container { background: rgba(0,0,0,0.6); color: inherit; }

        .progress-bar { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.2s; }
        
        #save-btn { display: none; background: var(--accent); color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 20px; }
        #status-icon { font-size: 3em; margin-bottom: 10px; color: var(--accent); }
    </style>
</head>
<body>

    <div class="container">
        <select style="float:right;" onchange="document.body.className='mode-'+this.value">
            <option value="default">Default</option>
            <option value="teacher">Teacher</option>
            <option value="company">Company</option>
            <option value="anime">Anime</option>
            <option value="hacker">Hacker</option>
        </select>

        <br><br>
        <i id="status-icon" class="fas fa-circle-notch fa-spin"></i>
        <h2 id="status-text">Connecting...</h2>
        <h3 id="file-name"></h3>

        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <div id="stats">Speed: 0 KB/s | Peers: 0</div>

        <a id="save-btn"><i class="fas fa-download"></i> Save Decrypted File</a>
        
        <!-- Video Player for Anime Mode -->
        <video id="player" controls style="width:100%; display:none; margin-top:15px; background:black;"></video>
    </div>

    <!-- DECRYPTION WORKER -->
    <script id="decrypt-worker" type="javascript/worker">
        self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js');
        self.onmessage = function(e) {
            const { packet, keyStr } = e.data;
            try {
                // 1. Split IV and Ciphertext (Format: IV:CIPHERTEXT)
                const parts = packet.split(':');
                if(parts.length !== 2) throw new Error("Invalid Packet Format");

                const ivHex = parts[0];
                const ciphertext = parts[1];

                // 2. Parse Key and IV
                const key = CryptoJS.enc.Hex.parse(keyStr);
                const iv = CryptoJS.enc.Hex.parse(ivHex);

                // 3. Decrypt
                const decrypted = CryptoJS.AES.decrypt(ciphertext, key, { iv: iv });
                
                // 4. Convert to Uint8Array for file saving
                const typedArray = convertWordArrayToUint8Array(decrypted);
                
                if(typedArray.length === 0) throw new Error("Decryption produced empty data (Wrong Key?)");

                self.postMessage({ status: 'success', buffer: typedArray.buffer }, [typedArray.buffer]);
            } catch(err) {
                self.postMessage({ status: 'error', msg: err.message });
            }
        };

        function convertWordArrayToUint8Array(wordArray) {
            const words = wordArray.words;
            const sigBytes = wordArray.sigBytes;
            const u8 = new Uint8Array(sigBytes);
            for (let i = 0; i < sigBytes; i++) {
                u8[i] = (words[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
            }
            return u8;
        }
    </script>

    <script>
        const trackers = [
            'wss://tracker.openwebtorrent.com',
            'wss://tracker.files.fm:7073/announce',
            'wss://tracker.webtorrent.dev'
        ];

        const client = new WebTorrent({ tracker: { announce: trackers } });
        const params = new URLSearchParams(window.location.search);
        const magnet = params.get('magnet');
        const key = params.get('key');
        
        const ui = {
            text: document.getElementById('status-text'),
            name: document.getElementById('file-name'),
            bar: document.getElementById('progress-fill'),
            stats: document.getElementById('stats'),
            btn: document.getElementById('save-btn'),
            icon: document.getElementById('status-icon'),
            player: document.getElementById('player')
        };

        if(!magnet || !key) {
            ui.text.innerText = "Error: Invalid Link";
            ui.text.style.color = "red";
            ui.icon.className = "fas fa-exclamation-triangle";
        } else {
            // Start Download
            client.add(magnet, { announce: trackers }, (torrent) => {
                ui.text.innerText = "Downloading...";
                ui.name.innerText = torrent.name;

                torrent.on('download', () => {
                    const p = (torrent.progress * 100).toFixed(1);
                    ui.bar.style.width = p + '%';
                    ui.stats.innerText = `Speed: ${(torrent.downloadSpeed/1024).toFixed(0)} KB/s | Peers: ${torrent.numPeers}`;
                });

                torrent.on('done', () => {
                    ui.text.innerText = "Decrypting (Please Wait)...";
                    ui.bar.style.background = "#2ecc71"; // Green
                    
                    torrent.files[0].getBuffer((err, buffer) => {
                        if(err) return alert(err);
                        const packet = new TextDecoder().decode(buffer);
                        startDecryption(packet, torrent.name);
                    });
                });
            });
        }

        function startDecryption(packet, filename) {
            const blob = new Blob([document.getElementById('decrypt-worker').textContent], {type: "text/javascript"});
            const worker = new Worker(URL.createObjectURL(blob));

            worker.postMessage({ packet: packet, keyStr: key });

            worker.onmessage = (e) => {
                if(e.data.status === 'success') {
                    ui.text.innerText = "Decryption Complete!";
                    ui.icon.className = "fas fa-check-circle";
                    
                    const fileBlob = new Blob([e.data.buffer]);
                    const url = URL.createObjectURL(fileBlob);
                    
                    ui.btn.href = url;
                    ui.btn.download = filename;
                    ui.btn.style.display = 'inline-block';
                    
                    // Video Preview Logic
                    if(filename.endsWith('.mp4') || filename.endsWith('.mkv')) {
                        ui.player.src = url;
                        ui.player.style.display = 'block';
                    }
                } else {
                    ui.text.innerText = "Decryption Failed!";
                    ui.stats.innerText = "Error: " + e.data.msg;
                    ui.icon.className = "fas fa-times-circle";
                    ui.icon.style.color = "red";
                }
                worker.terminate();
            };
        }
    </script>
</body>
</html>
